import { Callout } from "nextra/components";
import FeaturedCard from "../components/featuredCard";
import { Cards, Card } from "nextra/components";
import { Examples } from "../components/icons/examples";
import { HowTo } from "../components/icons/howto";
import { Tutorial } from "../components/icons/tutorial";
import { Tabs } from "nextra/components";

# Add Reflect to an Existing Project

Reflect works with just about any client-side web framework like React, Svelte, Solid or Vue. These steps show how to add Reflect to a few popular frameworks, but you should be able to adapt them to others.

<Callout type="warning">
  These instructions currently only work for TypeScript-based projects. For
  plain JavaScript, please see
  [reflect-starter-vanilla](https://github.com/rocicorp/reflect-starter-vanilla).
</Callout>

## Install and Setup

### Setup

Setup a boilerplate vite project for your framework of choice:

```bash copy
npm create vite
```

### Install
Run the following command in your project directory:

```bash copy
npx @rocicorp/reflect@latest init
```

This does three things:

1. Installs `@rocicorp/reflect`
2. Generates a `reflect.config.json` file
3. Generates a minimal Reflect server in the `/reflect` directory

Otherwise, it doesn't touch your directory at all and is non-destructive.

## Understand the Generated Code

### `reflect.config.json`

The generated `reflect.config.json` file looks like:

```json
{
  "server": "./reflect/index.ts"
}
```

This tells `reflect dev` and `reflect publish` where the entrypoint to your Reflect server is. The convention is to put your server in `/reflect`, but that's optional.

`reflect.config.json` should be checked into source control as it contains shared information about the project necessary for the Reflect CLI to work.

### `/reflect`

The generated `/reflect` directory contains a sample Reflect server. This is the part of your project that will run hosted on `reflect.net`.

`/reflect/index.ts` exports a `makeOptions` function which is the entrypoint to your server. It looks something like:

```ts
function makeOptions(): ReflectServerOptions<M> {
  return {
    authHandler,
    mutators,
    logLevel: "debug",
  };
}
```

See [authentication](/authentication) and [mutators](/mutators) to learn more about these options.

## Use Reflect

Somewhere in the client-side of your app, instantiate Reflect:

```ts copy
import { Reflect } from "@rocicorp/reflect/client";
import { mutators } from "../reflect/mutators.ts";

const r = new Reflect({
  userID: "someUser",
  roomID: "myRoom",
  server: "http://localhost:8080",
  mutators,
});
```

<Callout type="info">
  Reflect does not build or run on servers because it depends on DOM APIs. In
  Next.js, you can use Reflect in the browser by wrapping it in a `useEffect`
  hook.
</Callout>

The `/reflect` directory contains a sample `increment` mutator. Call it from some event handler:

```ts copy
const onClick = () => {
  r.mutate.increment({ key: "count", delta: 1 });
};
```

Use `r.subscribe` or (`useSubscribe` if using React) to monitor Reflect data:

<Callout>
Don't see your framework of choice? [Let us know](https://discord.reflect.net/) what we should add next.
</Callout>

<Tabs items={['vanilla', 'React',  'Solid', 'Vue', 'Svelte']}>
  <Tabs.Tab>
    ```js copy
    r.subscribe(
      (tx) => tx.get("count"),
      (value) => {
        myElm.textContent = value ?? 0;
      }
    );
    ````
  </Tabs.Tab>
  <Tabs.Tab>
    ```ts copy
    import { useSubscribe } from "@rocicorp/reflect/react";

    const count = useSubscribe(
      r,
      async (tx) => (await tx.get<number>("count")) ?? 0,
      0
    );
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```ts copy
    import { createSignal } from "solid-js";

    const [count, setCount] = createSignal(0);

    r.subscribe(
      (tx) => tx.get("count"),
      (data) => {
        setCount((data ?? 0) as number);
      }
    );
    ```
  </Tabs.Tab>
  <Tabs.Tab>
      ```ts copy
      import { ref } from 'vue'

      const count = ref(0)

      r.subscribe(
        (tx) => tx.get("count"),
        (data) => {
          count.value = (data ?? 0) as number;
        },
      );
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```ts copy
    let count: number = 0

    r.subscribe(
      (tx) => tx.get("count"),
      (data) => {
          count = (data ?? 0) as number;
      }
    );
    ```
  </Tabs.Tab>
</Tabs>



See [Data Modeling](./data-modeling) for more complex data storage needs.

## Develop

Start the local dev environment:

```bash copy
npx reflect dev
```

In a different tab, start the UI dev server:

```bash copy
npm run dev
```

## Publish

Deploy the Reflect server to [reflect.net](https://reflect.net/):

```bash copy
npx reflect publish
```

Deploy the UI. You can use any hosting provider, we'll use Vercel here:

```bash copy
npx vercel
```

Note that you will have to change the `socketOrigin` in the `Reflect` constructor to point to your remote Reflect server (i.e., `wss://my-app.my-user.reflect-server.net`).

## Next Steps

<Cards>
  <Card icon={<HowTo />} title="Learn to use Reflect" href="/rooms" />
  <Card icon={<Examples />} title="Browse example apps" href="/examples" />
  <Card
    icon={<HowTo />}
    title="Understand Reflect's design"
    href="/server-authority"
  />
</Cards>
